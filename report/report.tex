\documentclass[11pt]{article}

    \usepackage[breakable]{tcolorbox}
    \usepackage{parskip} % Stop auto-indenting (to mimic markdown behaviour)
    
    \usepackage{iftex}
    \ifPDFTeX
    	\usepackage[T1]{fontenc}
    	\usepackage{mathpazo}
    \else
    	\usepackage{fontspec}
    \fi

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % Maintain compatibility with old templates. Remove in nbconvert 6.0
    \let\Oldincludegraphics\includegraphics
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionFormat{nocaption}{}
    \captionsetup{format=nocaption,aboveskip=0pt,belowskip=0pt}

    \usepackage[Export]{adjustbox} % Used to constrain images to a maximum size
    \adjustboxset{max size={0.9\linewidth}{0.9\paperheight}}
    \usepackage{float}
    \floatplacement{figure}{H} % forces figures to be placed at the correct location
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range
    \makeatletter % fix for grffile with XeLaTeX
    \def\Gread@@xetex#1{%
      \IfFileExists{"\Gin@base".bb}%
      {\Gread@eps{\Gin@base.bb}}%
      {\Gread@@xetex@aux#1}%
    }
    \makeatother

    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    % The default LaTeX title has an obnoxious amount of whitespace. By default,
    % titling removes some of it. It also provides customization options.
    \usepackage{titling}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    \usepackage{mathrsfs}
    

    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}
    \definecolor{ansi-default-inverse-fg}{HTML}{FFFFFF}
    \definecolor{ansi-default-inverse-bg}{HTML}{000000}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatibility definitions
    \def\gt{>}
    \def\lt{<}
    \let\Oldtex\TeX
    \let\Oldlatex\LaTeX
    \renewcommand{\TeX}{\textrm{\Oldtex}}
    \renewcommand{\LaTeX}{\textrm{\Oldlatex}}
    % Document parameters
    % Document title
    
    
    
    
    
% Pygments definitions
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % For linebreaks inside Verbatim environment from package fancyvrb. 
    \makeatletter
        \newbox\Wrappedcontinuationbox 
        \newbox\Wrappedvisiblespacebox 
        \newcommand*\Wrappedvisiblespace {\textcolor{red}{\textvisiblespace}} 
        \newcommand*\Wrappedcontinuationsymbol {\textcolor{red}{\llap{\tiny$\m@th\hookrightarrow$}}} 
        \newcommand*\Wrappedcontinuationindent {3ex } 
        \newcommand*\Wrappedafterbreak {\kern\Wrappedcontinuationindent\copy\Wrappedcontinuationbox} 
        % Take advantage of the already applied Pygments mark-up to insert 
        % potential linebreaks for TeX processing. 
        %        {, <, #, %, $, ' and ": go to next line. 
        %        _, }, ^, &, >, - and ~: stay at end of broken line. 
        % Use of \textquotesingle for straight quote. 
        \newcommand*\Wrappedbreaksatspecials {% 
            \def\PYGZus{\discretionary{\char`\_}{\Wrappedafterbreak}{\char`\_}}% 
            \def\PYGZob{\discretionary{}{\Wrappedafterbreak\char`\{}{\char`\{}}% 
            \def\PYGZcb{\discretionary{\char`\}}{\Wrappedafterbreak}{\char`\}}}% 
            \def\PYGZca{\discretionary{\char`\^}{\Wrappedafterbreak}{\char`\^}}% 
            \def\PYGZam{\discretionary{\char`\&}{\Wrappedafterbreak}{\char`\&}}% 
            \def\PYGZlt{\discretionary{}{\Wrappedafterbreak\char`\<}{\char`\<}}% 
            \def\PYGZgt{\discretionary{\char`\>}{\Wrappedafterbreak}{\char`\>}}% 
            \def\PYGZsh{\discretionary{}{\Wrappedafterbreak\char`\#}{\char`\#}}% 
            \def\PYGZpc{\discretionary{}{\Wrappedafterbreak\char`\%}{\char`\%}}% 
            \def\PYGZdl{\discretionary{}{\Wrappedafterbreak\char`\$}{\char`\$}}% 
            \def\PYGZhy{\discretionary{\char`\-}{\Wrappedafterbreak}{\char`\-}}% 
            \def\PYGZsq{\discretionary{}{\Wrappedafterbreak\textquotesingle}{\textquotesingle}}% 
            \def\PYGZdq{\discretionary{}{\Wrappedafterbreak\char`\"}{\char`\"}}% 
            \def\PYGZti{\discretionary{\char`\~}{\Wrappedafterbreak}{\char`\~}}% 
        } 
        % Some characters . , ; ? ! / are not pygmentized. 
        % This macro makes them "active" and they will insert potential linebreaks 
        \newcommand*\Wrappedbreaksatpunct {% 
            \lccode`\~`\.\lowercase{\def~}{\discretionary{\hbox{\char`\.}}{\Wrappedafterbreak}{\hbox{\char`\.}}}% 
            \lccode`\~`\,\lowercase{\def~}{\discretionary{\hbox{\char`\,}}{\Wrappedafterbreak}{\hbox{\char`\,}}}% 
            \lccode`\~`\;\lowercase{\def~}{\discretionary{\hbox{\char`\;}}{\Wrappedafterbreak}{\hbox{\char`\;}}}% 
            \lccode`\~`\:\lowercase{\def~}{\discretionary{\hbox{\char`\:}}{\Wrappedafterbreak}{\hbox{\char`\:}}}% 
            \lccode`\~`\?\lowercase{\def~}{\discretionary{\hbox{\char`\?}}{\Wrappedafterbreak}{\hbox{\char`\?}}}% 
            \lccode`\~`\!\lowercase{\def~}{\discretionary{\hbox{\char`\!}}{\Wrappedafterbreak}{\hbox{\char`\!}}}% 
            \lccode`\~`\/\lowercase{\def~}{\discretionary{\hbox{\char`\/}}{\Wrappedafterbreak}{\hbox{\char`\/}}}% 
            \catcode`\.\active
            \catcode`\,\active 
            \catcode`\;\active
            \catcode`\:\active
            \catcode`\?\active
            \catcode`\!\active
            \catcode`\/\active 
            \lccode`\~`\~ 	
        }
    \makeatother

    \let\OriginalVerbatim=\Verbatim
    \makeatletter
    \renewcommand{\Verbatim}[1][1]{%
        %\parskip\z@skip
        \sbox\Wrappedcontinuationbox {\Wrappedcontinuationsymbol}%
        \sbox\Wrappedvisiblespacebox {\FV@SetupFont\Wrappedvisiblespace}%
        \def\FancyVerbFormatLine ##1{\hsize\linewidth
            \vtop{\raggedright\hyphenpenalty\z@\exhyphenpenalty\z@
                \doublehyphendemerits\z@\finalhyphendemerits\z@
                \strut ##1\strut}%
        }%
        % If the linebreak is at a space, the latter will be displayed as visible
        % space at end of first line, and a continuation symbol starts next line.
        % Stretch/shrink are however usually zero for typewriter font.
        \def\FV@Space {%
            \nobreak\hskip\z@ plus\fontdimen3\font minus\fontdimen4\font
            \discretionary{\copy\Wrappedvisiblespacebox}{\Wrappedafterbreak}
            {\kern\fontdimen2\font}%
        }%
        
        % Allow breaks at special characters using \PYG... macros.
        \Wrappedbreaksatspecials
        % Breaks at punctuation characters . , ; ? ! and / need catcode=\active 	
        \OriginalVerbatim[#1,codes*=\Wrappedbreaksatpunct]%
    }
    \makeatother

    % Exact colors from NB
    \definecolor{incolor}{HTML}{303F9F}
    \definecolor{outcolor}{HTML}{D84315}
    \definecolor{cellborder}{HTML}{CFCFCF}
    \definecolor{cellbackground}{HTML}{F7F7F7}
    
    % prompt
    \makeatletter
    \newcommand{\boxspacing}{\kern\kvtcb@left@rule\kern\kvtcb@boxsep}
    \makeatother
    \newcommand{\prompt}[4]{
        \ttfamily\llap{{\color{#2}[#3]:\hspace{3pt}#4}}\vspace{-\baselineskip}
    }
    

    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

\begin{document}
    \hypertarget{image-processing-and-computer-vision-2019-2020}{%
\section{Image Processing and Computer Vision
2019-2020}\label{image-processing-and-computer-vision-2019-2020}}

\textbf{Prof.~Luigi Di Stefano}\\
luigi.distefano@unibo.it

Master Degree in Artificial Intelligence\\
DISI - University of Bologna, Bologna

    \textbf{Project name}\\
Visual Inspection of Motorcycle Connecting Rods\\
\textbf{Student}\\
Alessandro Lombardi\\
alessandro.lombardi5@studio.unibo.it

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{1}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} import libraries}
\PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
\PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k+kn}{import} \PY{n}{cm}
\PY{k+kn}{from} \PY{n+nn}{mpl\PYZus{}toolkits}\PY{n+nn}{.}\PY{n+nn}{mplot3d} \PY{k+kn}{import} \PY{n}{Axes3D}
\PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k+kn}{import} \PY{n}{pyplot} \PY{k}{as} \PY{n}{plt}
\PY{k+kn}{import} \PY{n+nn}{cv2}
\PY{k+kn}{import} \PY{n+nn}{math}

\PY{o}{\PYZpc{}}\PY{k}{matplotlib} inline
\end{Verbatim}
\end{tcolorbox}

    \hypertarget{task-1}{%
\subsection{Task 1}\label{task-1}}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{2}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} file names of the task 1}
\PY{n}{task1\PYZus{}image\PYZus{}filenames} \PY{o}{=} \PY{p}{[}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI00.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI01.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI12.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI21.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI31.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Tesi33.bmp}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}
\end{Verbatim}
\end{tcolorbox}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{3}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} the index of the array corresponding to the chosen image, that will be used in next cells}
\PY{n}{index} \PY{o}{=} \PY{l+m+mi}{3}
\end{Verbatim}
\end{tcolorbox}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{4}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} read the image and store it}
\PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{../data/}\PY{l+s+s2}{\PYZdq{}} \PY{o}{+} \PY{n}{task1\PYZus{}image\PYZus{}filenames}\PY{p}{[}\PY{n}{index}\PY{p}{]}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{IMREAD\PYZus{}GRAYSCALE}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{n}{task1\PYZus{}image\PYZus{}filenames}\PY{p}{[}\PY{n}{index}\PY{p}{]}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_6_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Drawing the histogram it is possible to observe two different regions
that represents the two semantically different parts of the image, the
foreground, which is darker, and the background, which is brighter. The
foreground is more restricted to a smaller range of intensities whereas
the background present a wider range due to illumination conditions.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{5}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{image}\PY{o}{.}\PY{n}{ravel}\PY{p}{(}\PY{p}{)}\PY{p}{,}\PY{l+m+mi}{256}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{256}\PY{p}{]}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_8_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    To confirm this observation it is possible to ignore it and try to
increase even more the contrast using the Histogram Equalization, but as
expected, the obtained result is not better.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{6}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{equalized} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{equalizeHist}\PY{p}{(}\PY{n}{image}\PY{p}{)}

\PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Original Image}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image}\PY{p}{)}

\PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Histogram equalization}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{equalized}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_10_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Then excluded the presence of noise in the image it is possible to jump
to the next step: segmentantion. The objective is to divide the
foreground from the background and obtain a more useful binary image.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{7}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} try out different segmentation techniques to choose the proper one}
\PY{n}{binay\PYZus{}threshold} \PY{o}{=} \PY{n+nb}{round}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{image}\PY{p}{)}\PY{p}{)}
\PY{n}{ret\PYZus{}binary}\PY{p}{,} \PY{n}{th\PYZus{}binary} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{threshold}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{binay\PYZus{}threshold}\PY{p}{,} \PY{l+m+mi}{255}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{THRESH\PYZus{}BINARY}\PY{p}{)}
\PY{n}{ret\PYZus{}otsu}\PY{p}{,} \PY{n}{th\PYZus{}otsu} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{threshold}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{255}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{THRESH\PYZus{}BINARY\PYZus{}INV} \PY{o}{+} \PY{n}{cv2}\PY{o}{.}\PY{n}{THRESH\PYZus{}OTSU}\PY{p}{)}
\PY{n}{th\PYZus{}mean} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{adaptiveThreshold}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{l+m+mi}{255}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{ADAPTIVE\PYZus{}THRESH\PYZus{}MEAN\PYZus{}C}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{THRESH\PYZus{}BINARY}\PY{p}{,} \PY{l+m+mi}{47}\PY{p}{,} \PY{l+m+mi}{14}\PY{p}{)}
\PY{n}{th\PYZus{}gaussian} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{adaptiveThreshold}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{l+m+mi}{255}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{ADAPTIVE\PYZus{}THRESH\PYZus{}GAUSSIAN\PYZus{}C}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{THRESH\PYZus{}BINARY}\PY{p}{,} \PY{l+m+mi}{47}\PY{p}{,} \PY{l+m+mi}{14}\PY{p}{)}

\PY{n}{titles} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Global Thresholding (mean = }\PY{l+s+s1}{\PYZsq{}} \PY{o}{+} \PY{n+nb}{str}\PY{p}{(}\PY{n}{binay\PYZus{}threshold}\PY{p}{)} \PY{o}{+} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{)}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Otsu Thresholding}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Adaptive Mean Thresholding}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Adaptive Gaussian Thresholding}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
\PY{n}{images} \PY{o}{=} \PY{p}{[}\PY{n}{th\PYZus{}binary}\PY{p}{,} \PY{n}{th\PYZus{}otsu}\PY{p}{,} \PY{n}{th\PYZus{}mean}\PY{p}{,} \PY{n}{th\PYZus{}gaussian}\PY{p}{]}

\PY{c+c1}{\PYZsh{} plot them to make comparisons}
\PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mf}{17.5}\PY{p}{,} \PY{l+m+mf}{12.5}\PY{p}{)}\PY{p}{)}

\PY{k}{for} \PY{n}{i}\PY{p}{,} \PY{n}{img} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{images}\PY{p}{)}\PY{p}{:}
    \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{,}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}
    \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{img}\PY{p}{)}
    \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{n}{titles}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}
    \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_12_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    From previous images it is possible to observe that with variation of
the intensity on the background the global thresholding with the mean
does not handle correctly the segmentation, because the regions may
occupy in each image different portions of the total area, for this
reason using the mean or other percentiles must be abandoned. Both the
Adaptive Mean and the Gaussian Thresholding must be tuned to reduce the
intensity of noise on the background, but by doing so a terrible side
effect generates holes inside the rods. The Otsu Thresholding is the
most promising, because only in one image provides a small imprecise and
jagged contour that may cause some troubles in successive operations. To
solve this problem, a closing followed by a opening is needed. In
addition, Otsu is a better choice because works without setting or
tuning any parameter.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{8}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} close and open to remove small holes (especially for image \PYZdq{}TESI21.BMP\PYZdq{})}
\PY{n}{kernel} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{getStructuringElement}\PY{p}{(}\PY{n}{cv2}\PY{o}{.}\PY{n}{MORPH\PYZus{}CROSS}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
\PY{n}{th\PYZus{}otsu} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{morphologyEx}\PY{p}{(}\PY{n}{cv2}\PY{o}{.}\PY{n}{morphologyEx}\PY{p}{(}\PY{n}{th\PYZus{}otsu}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{MORPH\PYZus{}CLOSE}\PY{p}{,} \PY{n}{kernel}\PY{p}{)}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{MORPH\PYZus{}OPEN}\PY{p}{,} \PY{n}{kernel}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{th\PYZus{}otsu}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_14_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \textbf{strategies} - To classify the rods in the two classes A or B it
is necessary to count the holes. A first connected components labeling
is applied to extract the rods, then, for each rod, another one is
applied to the negative of the image containing only the specific rod to
find its holes. - The first connected components labeling finds also for
each rod its barycentre. - The second connected components labeling
finds also barycentre and diameter (computed from the area) of the
holes. - To find the orientation it is necessary to find firstly the
major axis and then the angle between it and the horizontal axis. The
major and minor axes are found deploying the covariance matrix obtained
using the second order central moments of the image and the centroid of
the blob (that can be computed using moments too)

$\mu{}_2{}_0 = M{}_2{}_0 - \cfrac{M{}_1{}_0}{M{}_0{}_0}M{}_1{}_0$ \\
$\mu{}_0{}_2 = M{}_0{}_2 - \cfrac{M{}_0{}_1}{M{}_0{}_0}M{}_0{}_1$ \\
$\mu{}_1{}_1 = M{}_1{}_1 - \cfrac{M{}_1{}_0}{M{}_0{}_0}M{}_1{}_0 = M{}_1{}_1 - \cfrac{M{}_0{}_1}{M{}_0{}_0}M{}_0{}_1$ \\  
$\mu'{}_2{}_0 = \cfrac{\mu{}_2{}_0}{\mu{}_0{}_0}$ \\
$\mu'{}_0{}_2 = \cfrac{\mu{}_0{}_2}{\mu{}_0{}_0}$ \\
$\mu'{}_1{}_1 = \cfrac{\mu{}_1{}_1}{\mu{}_0{}_0}$ \\

\begin{equation}
    cov[I(x, y)] = 
    \begin{pmatrix}
        \mu'{}_1{}_1 & \mu'{}_0{}_2 \\
        \mu'{}_2{}_0 & \mu'{}_1{}_1 \\
    \end{pmatrix}
\end{equation}
\begin{center}
    $\theta = \cfrac{1}{2}arctan(\cfrac{2\mu'{}_1{}_1}{\mu'{}_2{}_0 - \mu'{}_0{}_2})$     
\end{center}

\begin{verbatim}
https://en.wikipedia.org/wiki/Image_moment
\end{verbatim}

\begin{itemize}
\tightlist
\item
  The eigenvectors of this matrix correspond to the major and minor axes
  of the image intensity, so the orientation can thus be extracted from
  the angle of the eigenvector associated with the largest eigenvalue
  towards the axis closest to this eigenvector.
\item
  The major and minor axes are then used to find the contact points
  between the rod and its oriented Minimum Enclosing Rectangle. During
  this procedure is also updated the width at the barycentre considering
  points that belong to the minor axis, in a similar way as the contact
  points are found.
\item
  The contact points are finally used to compute the vertices of the
  Minimum Enclosing Rectangle, considering that its segments are
  parallel to major and minor axes and pass through the first.
\item
  Finally, from the vertices of the Minimum Enclosing Rectangle, it is
  possible to measure the height and the width of the rod.
\end{itemize}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{9}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{mn\PYZus{}moment}\PY{p}{(}\PY{n}{data}\PY{p}{,} \PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{)}\PY{p}{:}
    \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{} Measure the moments of the image given the order m and n}
\PY{l+s+sd}{    Inputs:}
\PY{l+s+sd}{        data \PYZhy{} the binary image as numpy matrix}
\PY{l+s+sd}{        m \PYZhy{} order of the vertical axis}
\PY{l+s+sd}{        n \PYZhy{} order of the horizontal axis}
\PY{l+s+sd}{    Output:}
\PY{l+s+sd}{        the moment}
\PY{l+s+sd}{    \PYZsq{}\PYZsq{}\PYZsq{}}
    \PY{k}{if} \PY{n}{data} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{data}\PY{o}{.}\PY{n}{size} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{or} \PY{n}{m} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{n} \PY{o+ow}{is} \PY{k+kc}{None}\PY{p}{:}
        \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Missing some required arguments}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
    
    \PY{n}{nrows}\PY{p}{,} \PY{n}{ncols} \PY{o}{=} \PY{n}{data}\PY{o}{.}\PY{n}{shape}
    \PY{n}{y\PYZus{}indices}\PY{p}{,} \PY{n}{x\PYZus{}indices} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{mgrid}\PY{p}{[}\PY{p}{:}\PY{n}{nrows}\PY{p}{,} \PY{p}{:}\PY{n}{ncols}\PY{p}{]}
    \PY{k}{return} \PY{p}{(}\PY{n}{data} \PY{o}{*} \PY{n}{x\PYZus{}indices} \PY{o}{*}\PY{o}{*} \PY{n}{m} \PY{o}{*} \PY{n}{y\PYZus{}indices} \PY{o}{*}\PY{o}{*} \PY{n}{n}\PY{p}{)}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{10}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{moments\PYZus{}cov}\PY{p}{(}\PY{n}{data}\PY{p}{,} \PY{n}{centroid}\PY{p}{)}\PY{p}{:}
    \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{} Create the covariance matrix using the second order central moments}
\PY{l+s+sd}{    Inputs:}
\PY{l+s+sd}{        data \PYZhy{} the binary image as numpy matrix}
\PY{l+s+sd}{        centroid \PYZhy{} the centroid coordinate as array or tuple}
\PY{l+s+sd}{    Output:}
\PY{l+s+sd}{        the covariance matrix containing the moments}
\PY{l+s+sd}{    \PYZsq{}\PYZsq{}\PYZsq{}}
    \PY{k}{if} \PY{n}{data} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{data}\PY{o}{.}\PY{n}{size} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{or} \PY{n}{centroid} \PY{o+ow}{is} \PY{k+kc}{None}\PY{p}{:}
        \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Some required arguments are not correct}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
    
    \PY{n}{m10} \PY{o}{=} \PY{n}{mn\PYZus{}moment}\PY{p}{(}\PY{n}{data}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{)}
    \PY{n}{m01} \PY{o}{=} \PY{n}{mn\PYZus{}moment}\PY{p}{(}\PY{n}{data}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}
    \PY{n}{m00} \PY{o}{=} \PY{n}{mn\PYZus{}moment}\PY{p}{(}\PY{n}{data}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{)}
    \PY{n}{u11} \PY{o}{=} \PY{p}{(}\PY{n}{mn\PYZus{}moment}\PY{p}{(}\PY{n}{data}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)} \PY{o}{\PYZhy{}} \PY{n}{centroid}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*} \PY{n}{m01}\PY{p}{)} \PY{o}{/} \PY{n}{m00}
    \PY{n}{u20} \PY{o}{=} \PY{p}{(}\PY{n}{mn\PYZus{}moment}\PY{p}{(}\PY{n}{data}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{)} \PY{o}{\PYZhy{}} \PY{n}{centroid}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*} \PY{n}{m10}\PY{p}{)} \PY{o}{/} \PY{n}{m00}
    \PY{n}{u02} \PY{o}{=} \PY{p}{(}\PY{n}{mn\PYZus{}moment}\PY{p}{(}\PY{n}{data}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)} \PY{o}{\PYZhy{}} \PY{n}{centroid}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{n}{m01}\PY{p}{)} \PY{o}{/} \PY{n}{m00}
    \PY{k}{return} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{n}{u20}\PY{p}{,} \PY{n}{u11}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{u11}\PY{p}{,} \PY{n}{u02}\PY{p}{]}\PY{p}{]}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{11}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{contact\PYZus{}points}\PY{p}{(}\PY{n}{data}\PY{p}{,} \PY{n}{major\PYZus{}equation}\PY{p}{,} \PY{n}{minor\PYZus{}equation}\PY{p}{)}\PY{p}{:}
    \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{} Find the contact points between major and minor axes parallel lines and the contour of the object }
\PY{l+s+sd}{    and measure the width at the barycentre}
\PY{l+s+sd}{    Inputs:}
\PY{l+s+sd}{        data \PYZhy{} the binary image as numpy matrix}
\PY{l+s+sd}{        major\PYZus{}equation \PYZhy{} numpy array of type [a, b, c] representing the equation of the major axis}
\PY{l+s+sd}{        major\PYZus{}equation \PYZhy{} numpy array of type [a, b, c] representing the equation of the minor axis}
\PY{l+s+sd}{    Outputs:}
\PY{l+s+sd}{        c1 \PYZhy{} on major axis, negative maximum}
\PY{l+s+sd}{        c2 \PYZhy{} on major axis, positive maximum}
\PY{l+s+sd}{        c3 \PYZhy{} on minor axis, negative maximum}
\PY{l+s+sd}{        c4 \PYZhy{} on minor axis, positive maximum}
\PY{l+s+sd}{        barycentre\PYZus{}width \PYZhy{} the width at the barycentre (along the minor axis)}
\PY{l+s+sd}{    \PYZsq{}\PYZsq{}\PYZsq{}}
    \PY{k}{if} \PY{n}{data} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{data}\PY{o}{.}\PY{n}{size} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{or} \PY{n}{major\PYZus{}equation} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{minor\PYZus{}equation} \PY{o+ow}{is} \PY{k+kc}{None}\PY{p}{:}
        \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Some required arguments are not correct}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
    
    \PY{c+c1}{\PYZsh{} initialize variables}
    \PY{n}{min\PYZus{}major\PYZus{}distance} \PY{o}{=} \PY{n}{math}\PY{o}{.}\PY{n}{inf}
    \PY{n}{max\PYZus{}major\PYZus{}distance} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{n}{math}\PY{o}{.}\PY{n}{inf}
    \PY{n}{min\PYZus{}minor\PYZus{}distance} \PY{o}{=} \PY{n}{math}\PY{o}{.}\PY{n}{inf}
    \PY{n}{max\PYZus{}minor\PYZus{}distance} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{n}{math}\PY{o}{.}\PY{n}{inf}
    \PY{n}{c1} \PY{o}{=} \PY{k+kc}{None}
    \PY{n}{c2} \PY{o}{=} \PY{k+kc}{None}
    \PY{n}{c3} \PY{o}{=} \PY{k+kc}{None}
    \PY{n}{c4} \PY{o}{=} \PY{k+kc}{None}    
    \PY{n}{min\PYZus{}barycentre\PYZus{}distance} \PY{o}{=} \PY{n}{math}\PY{o}{.}\PY{n}{inf}
    \PY{n}{max\PYZus{}barycentre\PYZus{}distance} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{n}{math}\PY{o}{.}\PY{n}{inf}

    \PY{c+c1}{\PYZsh{} for each point in the image, consider that coordinates could be misleading, moving in columns means changing the horizontal coordiante and vice vers}
    \PY{k}{for} \PY{n}{y} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{data}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{:}
        \PY{k}{for} \PY{n}{x} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{data}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
            \PY{k}{if} \PY{n}{data}\PY{p}{[}\PY{n}{y}\PY{p}{,}\PY{n}{x}\PY{p}{]} \PY{o}{==} \PY{l+m+mi}{255}\PY{p}{:}
                \PY{c+c1}{\PYZsh{} distance from the major axis as distance of a point to a line}
                \PY{n}{major\PYZus{}distance} \PY{o}{=} \PY{p}{(}\PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{n}{y} \PY{o}{+} \PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*} \PY{n}{x} \PY{o}{+} \PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)} \PY{o}{/} \PY{n}{math}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{p}{(}\PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*}\PY{o}{*} \PY{l+m+mi}{2}\PY{p}{)} \PY{o}{+} \PY{p}{(}\PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*}\PY{o}{*} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
                \PY{c+c1}{\PYZsh{} distance from the minor axis as distance of a point to a line}
                \PY{n}{minor\PYZus{}distance} \PY{o}{=} \PY{p}{(}\PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{n}{y} \PY{o}{+} \PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*} \PY{n}{x} \PY{o}{+} \PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)} \PY{o}{/} \PY{n}{math}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{p}{(}\PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*}\PY{o}{*} \PY{l+m+mi}{2}\PY{p}{)} \PY{o}{+} \PY{p}{(}\PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*}\PY{o}{*} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
                
                \PY{c+c1}{\PYZsh{} update contact points searching for extremum in both horizontal and vertical axes}
                \PY{k}{if} \PY{n}{major\PYZus{}distance} \PY{o}{\PYZlt{}} \PY{n}{min\PYZus{}major\PYZus{}distance}\PY{p}{:}
                    \PY{n}{min\PYZus{}major\PYZus{}distance} \PY{o}{=} \PY{n}{major\PYZus{}distance}
                    \PY{n}{c1} \PY{o}{=} \PY{p}{[}\PY{n}{x}\PY{p}{,} \PY{n}{y}\PY{p}{]}
                \PY{k}{if} \PY{n}{major\PYZus{}distance} \PY{o}{\PYZgt{}} \PY{n}{max\PYZus{}major\PYZus{}distance}\PY{p}{:}
                    \PY{n}{max\PYZus{}major\PYZus{}distance} \PY{o}{=} \PY{n}{major\PYZus{}distance} 
                    \PY{n}{c2} \PY{o}{=} \PY{p}{[}\PY{n}{x}\PY{p}{,} \PY{n}{y}\PY{p}{]}
                \PY{k}{if} \PY{n}{minor\PYZus{}distance} \PY{o}{\PYZlt{}} \PY{n}{min\PYZus{}minor\PYZus{}distance}\PY{p}{:}
                    \PY{n}{min\PYZus{}minor\PYZus{}distance} \PY{o}{=} \PY{n}{minor\PYZus{}distance}
                    \PY{n}{c3} \PY{o}{=} \PY{p}{[}\PY{n}{x}\PY{p}{,} \PY{n}{y}\PY{p}{]}
                \PY{k}{if} \PY{n}{minor\PYZus{}distance} \PY{o}{\PYZgt{}} \PY{n}{max\PYZus{}minor\PYZus{}distance}\PY{p}{:}
                    \PY{n}{max\PYZus{}minor\PYZus{}distance} \PY{o}{=} \PY{n}{minor\PYZus{}distance}
                    \PY{n}{c4} \PY{o}{=} \PY{p}{[}\PY{n}{x}\PY{p}{,} \PY{n}{y}\PY{p}{]}
                
                \PY{c+c1}{\PYZsh{} if the point is close to the minor axes then it is considered in computing the width at the barycentre}
                \PY{k}{if} \PY{n+nb}{abs}\PY{p}{(}\PY{n}{minor\PYZus{}distance}\PY{p}{)} \PY{o}{\PYZlt{}} \PY{l+m+mf}{0.75}\PY{p}{:}
                    \PY{c+c1}{\PYZsh{} the distances are computed on both directions and summed to obtain the final value}
                    \PY{k}{if} \PY{n}{major\PYZus{}distance} \PY{o}{\PYZlt{}} \PY{n}{min\PYZus{}barycentre\PYZus{}distance}\PY{p}{:}
                        \PY{n}{min\PYZus{}barycentre\PYZus{}distance} \PY{o}{=} \PY{n}{major\PYZus{}distance}
                    \PY{k}{if} \PY{n}{major\PYZus{}distance} \PY{o}{\PYZgt{}} \PY{n}{max\PYZus{}barycentre\PYZus{}distance}\PY{p}{:}
                        \PY{n}{max\PYZus{}barycentre\PYZus{}distance} \PY{o}{=} \PY{n}{major\PYZus{}distance}
    
    \PY{k}{return} \PY{n}{c1}\PY{p}{,} \PY{n}{c2}\PY{p}{,} \PY{n}{c3}\PY{p}{,} \PY{n}{c4}\PY{p}{,} \PY{n+nb}{abs}\PY{p}{(}\PY{n}{min\PYZus{}barycentre\PYZus{}distance}\PY{p}{)} \PY{o}{+} \PY{n+nb}{abs}\PY{p}{(}\PY{n}{max\PYZus{}barycentre\PYZus{}distance}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{12}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{line\PYZus{}intersection}\PY{p}{(}\PY{n}{p1}\PY{p}{,} \PY{n}{p2}\PY{p}{,} \PY{n}{m1}\PY{p}{,} \PY{n}{m2}\PY{p}{)}\PY{p}{:}
    \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{} Intersect 2 lines given 2 points and the associated slopes }
\PY{l+s+sd}{    Inputs:}
\PY{l+s+sd}{        p1 \PYZhy{} first point of first line [x,y]}
\PY{l+s+sd}{        p2 \PYZhy{} fist point of second line [x,y]}
\PY{l+s+sd}{        m1 \PYZhy{} slope of first line}
\PY{l+s+sd}{        m2 \PYZhy{} slope of second line}
\PY{l+s+sd}{    Outputs:}
\PY{l+s+sd}{        res \PYZhy{} an array containing the intersection point of the two lines if exists, an array of np.nan otherwise}
\PY{l+s+sd}{    \PYZsq{}\PYZsq{}\PYZsq{}}
    \PY{k}{if} \PY{n}{p1} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{p2} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{m1} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{m2} \PY{o+ow}{is} \PY{k+kc}{None}\PY{p}{:}
        \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Some required arguments are not correct}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}

    \PY{c+c1}{\PYZsh{} prepare the matrices to solve the linear system of equations to find the intersection if there is}
    \PY{n}{a} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{n}{m1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}
                  \PY{p}{[}\PY{o}{\PYZhy{}}\PY{n}{m2}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{)}
    \PY{n}{b} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{m1} \PY{o}{*} \PY{n}{p1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{m2} \PY{o}{*} \PY{n}{p2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{)}
    \PY{k}{try}\PY{p}{:}
        \PY{n}{res} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{solve}\PY{p}{(}\PY{n}{a}\PY{p}{,} \PY{n}{b}\PY{p}{)}
    \PY{k}{except}\PY{p}{:}
        \PY{n}{res} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{nan}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{nan}\PY{p}{]}\PY{p}{)}

    \PY{k}{return} \PY{n}{res}
\end{Verbatim}
\end{tcolorbox}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{13}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{main}\PY{p}{(}\PY{n}{image}\PY{p}{)}\PY{p}{:} 
    \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{} The core of the project, contains the main algorithm to solve the problem }
\PY{l+s+sd}{    Inputs:}
\PY{l+s+sd}{        image \PYZhy{} the image to be processed as numpy matrix}
\PY{l+s+sd}{    Outputs:}
\PY{l+s+sd}{        rods \PYZhy{} list of dictionaries containing all the results for each rod}
\PY{l+s+sd}{    \PYZsq{}\PYZsq{}\PYZsq{}}
    \PY{k}{if} \PY{n}{image} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{image}\PY{o}{.}\PY{n}{size} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
        \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Some required arguments are not correct}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
    
    \PY{c+c1}{\PYZsh{} find rods as connected components using a specific connectivity value  }
    \PY{n}{rod\PYZus{}connectivity} \PY{o}{=} \PY{l+m+mi}{4}

    \PY{c+c1}{\PYZsh{} rod\PYZus{}num, is the number of rods}
    \PY{c+c1}{\PYZsh{} rod\PYZus{}labelled\PYZus{}image, is the original image where each pixel is sunstituted by the correct label}
    \PY{c+c1}{\PYZsh{} rod\PYZus{}info, contains some informations about the blobs, as the area}
    \PY{c+c1}{\PYZsh{} rod\PYZus{}centroids, contains the centroid of each blob}
    \PY{n}{rod\PYZus{}num}\PY{p}{,} \PY{n}{rod\PYZus{}labelled\PYZus{}image}\PY{p}{,} \PY{n}{rod\PYZus{}info}\PY{p}{,} \PY{n}{rod\PYZus{}centroids} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{connectedComponentsWithStats}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{rod\PYZus{}connectivity}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{CV\PYZus{}32S}\PY{p}{)}
    \PY{n}{labels} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{unique}\PY{p}{(}\PY{n}{rod\PYZus{}labelled\PYZus{}image}\PY{p}{)}
    \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Labels found }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s2}{\PYZdq{}}\PY{o}{.}\PY{n}{format}\PY{p}{(}\PY{n}{rod\PYZus{}num}\PY{p}{)}\PY{p}{)}
    
    \PY{c+c1}{\PYZsh{} consider as a background the blob with maximum area}
    \PY{n}{background\PYZus{}label} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{argmax}\PY{p}{(}\PY{n}{rod\PYZus{}info}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{4}\PY{p}{]}\PY{p}{)}

    \PY{c+c1}{\PYZsh{} rods is a list of dictionaries containing the requested information for each rod}
    \PY{n}{rods} \PY{o}{=} \PY{p}{[}\PY{p}{]}

    \PY{c+c1}{\PYZsh{} for each label, so rod}
    \PY{k}{for} \PY{n}{label} \PY{o+ow}{in} \PY{n}{labels}\PY{p}{:}
        \PY{c+c1}{\PYZsh{} exclude background}
        \PY{k}{if} \PY{n}{label} \PY{o}{!=} \PY{n}{background\PYZus{}label}\PY{p}{:}
            
            \PY{c+c1}{\PYZsh{} create a binary image from the original one considering the labelled image: only the current rod will have the foreground value}
            \PY{n}{rod\PYZus{}image} \PY{o}{=} \PY{n}{th\PYZus{}otsu}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{p}{)}
            \PY{n}{rod\PYZus{}image}\PY{p}{[}\PY{n}{rod\PYZus{}labelled\PYZus{}image} \PY{o}{==} \PY{n}{label}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{255}
            \PY{n}{rod\PYZus{}image}\PY{p}{[}\PY{n}{rod\PYZus{}labelled\PYZus{}image} \PY{o}{!=} \PY{n}{label}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{0}

            \PY{c+c1}{\PYZsh{} create a binary image from the binary of the rod as its negative: only the holes of the current rod will have the foreground value}
            \PY{n}{hole\PYZus{}image} \PY{o}{=} \PY{l+m+mi}{255} \PY{o}{\PYZhy{}} \PY{n}{rod\PYZus{}image}    

            \PY{c+c1}{\PYZsh{} find holes as connected components}
            \PY{n}{hole\PYZus{}connectivity} \PY{o}{=} \PY{l+m+mi}{4}
            \PY{n}{hole\PYZus{}num}\PY{p}{,} \PY{n}{hole\PYZus{}labelled\PYZus{}image}\PY{p}{,} \PY{n}{hole\PYZus{}info}\PY{p}{,} \PY{n}{hole\PYZus{}centroids} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{connectedComponentsWithStats}\PY{p}{(}\PY{n}{hole\PYZus{}image}\PY{p}{,} \PY{n}{hole\PYZus{}connectivity}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{CV\PYZus{}32S}\PY{p}{)}

            \PY{c+c1}{\PYZsh{} exclude background and rod}
            \PY{n}{ignore\PYZus{}index} \PY{o}{=} \PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{argsort}\PY{p}{(}\PY{n}{hole\PYZus{}info}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{4}\PY{p}{]}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
  
            \PY{n}{rod} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{index}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:}\PY{n}{label}\PY{p}{\PYZcb{}}
            \PY{n}{rods}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{rod}\PY{p}{)}

            \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{area}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]} \PY{o}{=} \PY{n}{rod\PYZus{}info}\PY{p}{[}\PY{n}{label}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{4}\PY{p}{]}
            \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]} \PY{o}{=} \PY{n}{rod\PYZus{}centroids}\PY{p}{[}\PY{n}{label}\PY{p}{]}\PY{o}{.}\PY{n}{round}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{astype}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{int}\PY{p}{)}
            
            \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{holes}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]} \PY{o}{=} \PY{p}{[}\PY{p}{]}
            
            \PY{n}{counter} \PY{o}{=} \PY{l+m+mi}{0}
            \PY{c+c1}{\PYZsh{} iterating the holes if two are found then the rod is labelled, if more than 2 are found an error is raised}
            \PY{k}{for} \PY{n}{index}\PY{p}{,} \PY{n}{area} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{hole\PYZus{}info}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{4}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                \PY{k}{if} \PY{o+ow}{not} \PY{p}{(}\PY{n}{index} \PY{o+ow}{in} \PY{n}{ignore\PYZus{}index}\PY{p}{)} \PY{p}{:}
                    \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{holes}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{p}{\PYZob{}}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{diameter}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:}\PY{n+nb}{round}\PY{p}{(}\PY{n}{math}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{p}{(}\PY{n}{area} \PY{o}{/} \PY{n}{math}\PY{o}{.}\PY{n}{pi}\PY{p}{)}\PY{p}{)} \PY{o}{*} \PY{l+m+mi}{2}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centre}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:}\PY{n}{hole\PYZus{}centroids}\PY{p}{[}\PY{n}{index}\PY{p}{]}\PY{o}{.}\PY{n}{round}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{astype}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{int}\PY{p}{)}\PY{p}{\PYZcb{}}\PY{p}{)}
                    \PY{k}{if} \PY{n}{counter} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
                        \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{type}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]} \PY{o}{=} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{A}\PY{l+s+s2}{\PYZdq{}}
                        \PY{n}{counter} \PY{o}{+}\PY{o}{=} \PY{l+m+mi}{1}                        
                    \PY{k}{elif} \PY{n}{counter} \PY{o}{==} \PY{l+m+mi}{1}\PY{p}{:}
                        \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{type}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]} \PY{o}{=} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{B}\PY{l+s+s2}{\PYZdq{}}
                        \PY{n}{counter} \PY{o}{+}\PY{o}{=} \PY{l+m+mi}{1}
                    \PY{k}{elif} \PY{n}{counter} \PY{o}{\PYZgt{}} \PY{l+m+mi}{1}\PY{p}{:}
                        \PY{k}{raise} \PY{n+ne}{Exception}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Error too many holes in a single rod index }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s2}{\PYZdq{}}\PY{o}{.}\PY{n}{format}\PY{p}{(}\PY{n}{index}\PY{p}{)}\PY{p}{)}


            \PY{k}{if} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{holes}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]} \PY{o}{==} \PY{p}{[}\PY{p}{]}\PY{p}{:}
                 \PY{k}{raise} \PY{n+ne}{Exception}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Error too few holes in a single rod index}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}

            \PY{c+c1}{\PYZsh{} use covariance matrix to find major and minor axes}
            \PY{n}{cov} \PY{o}{=} \PY{n}{moments\PYZus{}cov}\PY{p}{(}\PY{n}{rod\PYZus{}image}\PY{p}{,} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{)}
            \PY{n}{eigenvalues}\PY{p}{,} \PY{n}{eigenvectors} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{eig}\PY{p}{(}\PY{n}{cov}\PY{p}{)}
            \PY{n}{sort\PYZus{}indices} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{argsort}\PY{p}{(}\PY{n}{eigenvalues}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}
            \PY{n}{major\PYZus{}axes} \PY{o}{=} \PY{n}{eigenvectors}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{sort\PYZus{}indices}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}
            \PY{n}{minor\PYZus{}axes} \PY{o}{=} \PY{n}{eigenvectors}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{sort\PYZus{}indices}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}

            \PY{c+c1}{\PYZsh{}alpha = \PYZhy{}math.sin(theta)}
            \PY{c+c1}{\PYZsh{}beta  =  math.cos(theta)}
            \PY{n}{alpha} \PY{o}{=} \PY{n}{major\PYZus{}axes}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
            \PY{n}{beta} \PY{o}{=} \PY{n}{major\PYZus{}axes}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}

            \PY{c+c1}{\PYZsh{} find theta}
            \PY{n}{theta} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mf}{0.5} \PY{o}{*} \PY{n}{math}\PY{o}{.}\PY{n}{atan2}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2} \PY{o}{*} \PY{n}{cov}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{cov}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{cov}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
            \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{angle}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]} \PY{o}{=} \PY{n+nb}{round}\PY{p}{(}\PY{n}{math}\PY{o}{.}\PY{n}{degrees}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}

            \PY{c+c1}{\PYZsh{} store major and minor equations}
            \PY{n}{major\PYZus{}equation} \PY{o}{=} \PY{p}{[}\PY{n}{alpha}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{beta}\PY{p}{,} \PY{n}{beta} \PY{o}{*} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{alpha} \PY{o}{*} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}
            \PY{n}{minor\PYZus{}equation} \PY{o}{=} \PY{p}{[}\PY{n}{beta}\PY{p}{,} \PY{n}{alpha}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{beta} \PY{o}{*} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{alpha} \PY{o}{*} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}

            \PY{c+c1}{\PYZsh{} find contact points and width at the barycentre}
            \PY{n}{c1}\PY{p}{,} \PY{n}{c2}\PY{p}{,} \PY{n}{c3}\PY{p}{,} \PY{n}{c4}\PY{p}{,} \PY{n}{barycentre\PYZus{}width} \PY{o}{=} \PY{n}{contact\PYZus{}points}\PY{p}{(}\PY{n}{rod\PYZus{}image}\PY{p}{,} \PY{n}{major\PYZus{}equation}\PY{p}{,} \PY{n}{minor\PYZus{}equation}\PY{p}{)}
            \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{baricentre\PYZus{}width}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]} \PY{o}{=} \PY{n+nb}{round}\PY{p}{(}\PY{n}{barycentre\PYZus{}width}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}
            
            \PY{c+c1}{\PYZsh{} compute MER vertices}
            \PY{n}{v1} \PY{o}{=} \PY{n}{line\PYZus{}intersection}\PY{p}{(}\PY{n}{c1}\PY{p}{,} \PY{n}{c3}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{/} \PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{/} \PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
            \PY{n}{v2} \PY{o}{=} \PY{n}{line\PYZus{}intersection}\PY{p}{(}\PY{n}{c1}\PY{p}{,} \PY{n}{c4}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{/} \PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{/} \PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
            \PY{n}{v3} \PY{o}{=} \PY{n}{line\PYZus{}intersection}\PY{p}{(}\PY{n}{c2}\PY{p}{,} \PY{n}{c3}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{/} \PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{/} \PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
            \PY{n}{v4} \PY{o}{=} \PY{n}{line\PYZus{}intersection}\PY{p}{(}\PY{n}{c2}\PY{p}{,} \PY{n}{c4}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{/} \PY{n}{major\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{/} \PY{n}{minor\PYZus{}equation}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}

            \PY{c+c1}{\PYZsh{} measure length and width}
            \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{lengtt}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]} \PY{o}{=} \PY{n+nb}{round}\PY{p}{(}\PY{n}{math}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{p}{(}\PY{p}{(}\PY{n}{v1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{v2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)} \PY{o}{+} \PY{p}{(}\PY{p}{(}\PY{n}{v1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{v2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}
            \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{width}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]} \PY{o}{=} \PY{n+nb}{round}\PY{p}{(}\PY{n}{math}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{p}{(}\PY{p}{(}\PY{n}{v1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{v3}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)} \PY{o}{+} \PY{p}{(}\PY{p}{(}\PY{n}{v1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{v3}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{)}

            \PY{c+c1}{\PYZsh{} Draw        }
            \PY{c+c1}{\PYZsh{} MER}
            \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{n}{v1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{v2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{v1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{v2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZsh{}0000ff}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{}blue}
            \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{n}{v2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{v4}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{v2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{v4}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZsh{}ff0000}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{}red}
            \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{n}{v3}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{v1}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{v3}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{v1}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZsh{}c932c1}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{}purple}
            \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{n}{v4}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{v3}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{v4}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{v3}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZsh{}00ff00}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{}green}

            \PY{c+c1}{\PYZsh{} Major and minor axes}
            \PY{n}{scale} \PY{o}{=} \PY{l+m+mi}{20}
            \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{n}{major\PYZus{}axes}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*} \PY{o}{\PYZhy{}}\PY{n}{scale} \PY{o}{*} \PY{l+m+mi}{2} \PY{o}{+} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{major\PYZus{}axes}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*} \PY{n}{scale} \PY{o}{*} \PY{l+m+mi}{2} \PY{o}{+} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{,}
                     \PY{p}{[}\PY{n}{major\PYZus{}axes}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{o}{\PYZhy{}}\PY{n}{scale} \PY{o}{*} \PY{l+m+mi}{2} \PY{o}{+} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{major\PYZus{}axes}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{n}{scale} \PY{o}{*} \PY{l+m+mi}{2} \PY{o}{+} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{black}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{p}{[}\PY{n}{minor\PYZus{}axes}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*} \PY{o}{\PYZhy{}}\PY{n}{scale} \PY{o}{+} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{minor\PYZus{}axes}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{*} \PY{n}{scale} \PY{o}{+} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{,}
                     \PY{p}{[}\PY{n}{minor\PYZus{}axes}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{o}{\PYZhy{}}\PY{n}{scale} \PY{o}{+} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{minor\PYZus{}axes}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{n}{scale} \PY{o}{+} \PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{[}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{centroid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{,} \PY{n}{color}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{black}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{rod\PYZus{}image}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{n}{rods}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
    \PY{k}{return} \PY{n}{rods}
\end{Verbatim}
\end{tcolorbox}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{14}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{main}\PY{p}{(}\PY{n}{th\PYZus{}otsu}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
Labels found 3
    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_21_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
\{'index': 1, 'area': 2480, 'centroid': array([116,  93]), 'holes': [\{'diameter':
29.03, 'centre': array([139,  47])\}, \{'diameter': 26.49, 'centre': array([ 86,
151])\}], 'type': 'B', 'angle': 62.94, 'baricentre\_width': 18.78, 'lengtt':
156.5, 'width': 37.26\}
    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_21_3.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{Verbatim}[commandchars=\\\{\}]
\{'index': 2, 'area': 5285, 'centroid': array([155, 163]), 'holes': [\{'diameter':
28.1, 'centre': array([202, 121])\}], 'type': 'A', 'angle': 42.25,
'baricentre\_width': 22.6, 'lengtt': 192.92, 'width': 56.98\}
    \end{Verbatim}

            \begin{tcolorbox}[breakable, size=fbox, boxrule=.5pt, pad at break*=1mm, opacityfill=0]
\prompt{Out}{outcolor}{14}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
[\{'index': 1,
  'area': 2480,
  'centroid': array([116,  93]),
  'holes': [\{'diameter': 29.03, 'centre': array([139,  47])\},
   \{'diameter': 26.49, 'centre': array([ 86, 151])\}],
  'type': 'B',
  'angle': 62.94,
  'baricentre\_width': 18.78,
  'lengtt': 156.5,
  'width': 37.26\},
 \{'index': 2,
  'area': 5285,
  'centroid': array([155, 163]),
  'holes': [\{'diameter': 28.1, 'centre': array([202, 121])\}],
  'type': 'A',
  'angle': 42.25,
  'baricentre\_width': 22.6,
  'lengtt': 192.92,
  'width': 56.98\}]
\end{Verbatim}
\end{tcolorbox}
        
    \hypertarget{task-2}{%
\subsection{Task 2}\label{task-2}}

    \hypertarget{change-1}{%
\subsubsection{Change 1}\label{change-1}}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{15}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} file names of the task 2 change 1}
\PY{n}{task2a\PYZus{}image\PYZus{}filenames} \PY{o}{=} \PY{p}{[}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI44.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI47.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI48.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI49.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
    \PY{p}{]}
\end{Verbatim}
\end{tcolorbox}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{16}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{index} \PY{o}{=} \PY{l+m+mi}{0}
\end{Verbatim}
\end{tcolorbox}

    \textbf{Strategies} The previous implementation already detect objects
without holes like screws, raising an exception, because in task 1 are
not considered legal. The problem is then limited to detect washers. To
solve this problem is possible to: - check if the detected object has a
circular form, extracting the contour and applying the Haralick's
Circularity - check if the detected object has a circular form, using
the Hough Transform - check if the distance between the object's
barycentre and its hole barycentre is small

All the techniques need to set parameters, the first one need a single
threshold, the second one a lot of parameters to identify the circles
and the third one a single threshold. The first one needs the contour
while the third one uses informations gained in the normal process of
recognition of type A and B, so it's more computationally efficient.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{17}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{minimum\PYZus{}distance\PYZus{}between\PYZus{}barycentres} \PY{o}{=} \PY{l+m+mi}{5}
\PY{k}{def} \PY{n+nf}{task1c\PYZus{}rod\PYZus{}filter}\PY{p}{(}\PY{n}{rod\PYZus{}centroid}\PY{p}{,} \PY{n}{hole\PYZus{}centroid}\PY{p}{)}\PY{p}{:}
    \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{    Inputs:}
\PY{l+s+sd}{        rod\PYZus{}centroid \PYZhy{} rod position as numpy array}
\PY{l+s+sd}{        hole\PYZus{}centroid \PYZhy{} hole position as numpy array}
\PY{l+s+sd}{    Outputs:}
\PY{l+s+sd}{        True if the rod must be filtered and not considered}
\PY{l+s+sd}{    \PYZsq{}\PYZsq{}\PYZsq{}}
    \PY{k}{if} \PY{n}{rod\PYZus{}centroid} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{rod\PYZus{}centroid}\PY{o}{.}\PY{n}{size} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{or} \PY{n}{hole\PYZus{}centroid} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{hole\PYZus{}centroid}\PY{o}{.}\PY{n}{size} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
        \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Some required arguments are not correct}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        
    \PY{n}{distance} \PY{o}{=} \PY{n}{math}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{p}{(}\PY{n}{hole\PYZus{}centroid}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{rod\PYZus{}centroid}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{o}{*} \PY{l+m+mi}{2} \PY{o}{+} \PY{p}{(}\PY{n}{hole\PYZus{}centroid}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{rod\PYZus{}centroid}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{o}{*} \PY{l+m+mi}{2}\PY{p}{)}
    \PY{n+nb}{print}\PY{p}{(}\PY{n}{distance}\PY{p}{)}
    \PY{k}{if} \PY{n}{distance} \PY{o}{\PYZlt{}} \PY{n}{minimum\PYZus{}distance\PYZus{}between\PYZus{}barycentres}\PY{p}{:}
        \PY{k}{return} \PY{k+kc}{True}
    \PY{k}{return} \PY{k+kc}{False}
\end{Verbatim}
\end{tcolorbox}

    \hypertarget{change-2}{%
\subsubsection{Change 2}\label{change-2}}

    The main challenge in dividing connected rods is represented by the
presence of low density areas such as the circles that are prone to
vanish even after light morphology operations. For this reason is not
easy to detect when an isolated small portion of a rod, such as a
semicircle shape, belongs to the rod or to another one.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{18}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{task2b\PYZus{}image\PYZus{}filenames} \PY{o}{=} \PY{p}{[}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI50.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI51.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
\PY{p}{]}

\PY{n}{index} \PY{o}{=} \PY{l+m+mi}{1}

\PY{n}{task2b\PYZus{}image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{../data/}\PY{l+s+s2}{\PYZdq{}} \PY{o}{+} \PY{n}{task2b\PYZus{}image\PYZus{}filenames}\PY{p}{[}\PY{n}{index}\PY{p}{]}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{IMREAD\PYZus{}GRAYSCALE}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    The opencv library includes the implementation of a very intersting
algorithm called Watershed Transformation. The main idea is to consider
the image as a topographic surface and the labeling process as a
flooding of this space. Opencv deploys a marker-controlled Watershed
Transformation, which is more reliable and obtains better results. The
markers represent the starting points of the flooding and are obtained
generating images in which each foreground region (rod) is represented
by a secured subset of its pixels, a smart way to obtain this is to
threshold the distance transformation of the image. Another tested
approach was to compute the skeleton of an image but the links between
touching rods were too strong. Dilating the image we obtain a new image
which surely contains the correct background. The difference between the
image containing the sure parts of each rod and the background contains
the areas which are are more crictical to label, and contains also the
contacting points. Then the watershed function is called passing the
distance transformation as a RGB image and the labelled connected
components considering that the unknown region must have 0 as a label.

Details on:\\
https://opencv-python-tutroals.readthedocs.io/en/latest/py\_tutorials/py\_imgproc/py\_watershed/py\_watershed.html\\
http://www.cmm.mines-paristech.fr/\textasciitilde beucher/wtshed.html

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{19}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} a tridimensional representation of the image that recall a topographic surface}
\PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{10}\PY{p}{,}\PY{l+m+mi}{10}\PY{p}{)}\PY{p}{)}
\PY{n}{ax} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{111}\PY{p}{,} \PY{n}{projection}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{3d}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\PY{n}{x}\PY{p}{,} \PY{n}{y} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{meshgrid}\PY{p}{(}\PY{n+nb}{range}\PY{p}{(}\PY{n}{task2b\PYZus{}image}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n+nb}{range}\PY{p}{(}\PY{n}{task2b\PYZus{}image}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}
\PY{n}{surface} \PY{o}{=} \PY{n}{ax}\PY{o}{.}\PY{n}{plot\PYZus{}surface}\PY{p}{(}\PY{n}{x}\PY{p}{,} \PY{n}{y}\PY{p}{,} \PY{n}{task2b\PYZus{}image}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{n}{cm}\PY{o}{.}\PY{n}{coolwarm}\PY{p}{,}
                       \PY{n}{linewidth}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{antialiased}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{fig}\PY{o}{.}\PY{n}{colorbar}\PY{p}{(}\PY{n}{surface}\PY{p}{,} \PY{n}{shrink}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{n}{aspect}\PY{o}{=}\PY{l+m+mi}{5}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_32_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{20}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} segmentation}
\PY{n}{\PYZus{}}\PY{p}{,} \PY{n}{task2b\PYZus{}th\PYZus{}otsu} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{threshold}\PY{p}{(}\PY{n}{task2b\PYZus{}image}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{255}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{THRESH\PYZus{}BINARY\PYZus{}INV} \PY{o}{+} \PY{n}{cv2}\PY{o}{.}\PY{n}{THRESH\PYZus{}OTSU}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Otsu thresholding}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{task2b\PYZus{}th\PYZus{}otsu}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}

\PY{c+c1}{\PYZsh{} close the image to cover some holes}
\PY{n}{kernel} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{getStructuringElement}\PY{p}{(}\PY{n}{cv2}\PY{o}{.}\PY{n}{MORPH\PYZus{}ELLIPSE}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{4}\PY{p}{,}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{)}
\PY{n}{opening} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{morphologyEx}\PY{p}{(}\PY{n}{task2b\PYZus{}th\PYZus{}otsu}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{MORPH\PYZus{}CLOSE}\PY{p}{,} \PY{n}{kernel}\PY{p}{,} \PY{n}{iterations} \PY{o}{=} \PY{l+m+mi}{2}\PY{p}{)}

\PY{c+c1}{\PYZsh{} sure background area as a dilation}
\PY{n}{sure\PYZus{}bg} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{dilate}\PY{p}{(}\PY{n}{task2b\PYZus{}th\PYZus{}otsu}\PY{p}{,} \PY{n}{kernel}\PY{p}{,} \PY{n}{iterations}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Sure background}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{sure\PYZus{}bg}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}

\PY{c+c1}{\PYZsh{} Finding sure foreground area as a threshold of the distance transformation}
\PY{n}{mask\PYZus{}size} \PY{o}{=} \PY{l+m+mi}{5}
\PY{n}{dist\PYZus{}transform} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{distanceTransform}\PY{p}{(}\PY{n}{task2b\PYZus{}th\PYZus{}otsu}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{DIST\PYZus{}L2}\PY{p}{,} \PY{n}{mask\PYZus{}size}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Distance transformation}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{dist\PYZus{}transform}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}

\PY{n}{\PYZus{}}\PY{p}{,} \PY{n}{sure\PYZus{}fg} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{threshold}\PY{p}{(}\PY{n}{dist\PYZus{}transform}\PY{p}{,} \PY{l+m+mf}{0.5} \PY{o}{*} \PY{n}{dist\PYZus{}transform}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{255}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{)}
\PY{n}{sure\PYZus{}fg} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{uint8}\PY{p}{(}\PY{n}{sure\PYZus{}fg}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Sure foreground}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{sure\PYZus{}fg}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}

\PY{c+c1}{\PYZsh{} Finding unknown regions}
\PY{n}{unknown} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{subtract}\PY{p}{(}\PY{n}{sure\PYZus{}bg}\PY{p}{,} \PY{n}{sure\PYZus{}fg}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Unknown area}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{unknown}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_33_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_33_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_33_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_33_3.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_33_4.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{21}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} Marker labelling}
\PY{n}{\PYZus{}}\PY{p}{,} \PY{n}{markers} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{connectedComponents}\PY{p}{(}\PY{n}{sure\PYZus{}fg}\PY{p}{)}

\PY{c+c1}{\PYZsh{} Apply some preprocessing because the watershed algorithm consider 0 labelled regions as the unknowns}
\PY{c+c1}{\PYZsh{} Add one to all labels so that sure background is not 0, but 1}
\PY{n}{markers} \PY{o}{=} \PY{n}{markers} \PY{o}{+} \PY{l+m+mi}{1}

\PY{c+c1}{\PYZsh{} Mark the region of unknown with zero}
\PY{n}{markers}\PY{p}{[}\PY{n}{unknown} \PY{o}{==} \PY{l+m+mi}{255}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{0}

\PY{c+c1}{\PYZsh{} Prepare data}
\PY{n}{markers} \PY{o}{=} \PY{n}{markers}\PY{o}{.}\PY{n}{astype}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{int32}\PY{p}{)}
\PY{n}{dist\PYZus{}transform} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{uint8}\PY{p}{(}\PY{n}{dist\PYZus{}transform}\PY{p}{)}

\PY{c+c1}{\PYZsh{} Apply algorithm}
\PY{n}{resulting\PYZus{}regions} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{watershed}\PY{p}{(}\PY{n}{cv2}\PY{o}{.}\PY{n}{cvtColor}\PY{p}{(}\PY{n}{task2b\PYZus{}image}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{COLOR\PYZus{}GRAY2BGR}\PY{p}{)}\PY{p}{,} \PY{n}{markers}\PY{p}{)}

\PY{c+c1}{\PYZsh{} Print labelled parts}
\PY{k}{for} \PY{n}{region} \PY{o+ow}{in} \PY{n}{np}\PY{o}{.}\PY{n}{unique}\PY{p}{(}\PY{n}{resulting\PYZus{}regions}\PY{p}{)}\PY{p}{:}
    \PY{c+c1}{\PYZsh{} ignore background}
    \PY{k}{if} \PY{n}{region} \PY{o}{==} \PY{l+m+mi}{1}\PY{p}{:}
        \PY{k}{continue}

    \PY{n}{region\PYZus{}image} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{task2b\PYZus{}th\PYZus{}otsu}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
    \PY{n}{region\PYZus{}image}\PY{p}{[}\PY{n}{resulting\PYZus{}regions} \PY{o}{==} \PY{n}{region}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{255}
    
    \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{region\PYZus{}image}\PY{p}{)}
    \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_34_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_34_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_34_2.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_34_3.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Unfortunalely the result are not usable, maybe other refinements are
needed, for example dealing better with small and low density regions of
the image which tends to be not clearly connected to the rest of the
rod. Otherwise can be implemented an enhancement of the Watershed
algorithm called P Algorithm

    \hypertarget{change-3}{%
\subsubsection{Change 3}\label{change-3}}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{22}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} file names of the task 2 change 3}
\PY{n}{task2c\PYZus{}image\PYZus{}filenames} \PY{o}{=} \PY{p}{[}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI90.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI92.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}
    \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{TESI98.BMP}\PY{l+s+s2}{\PYZdq{}}\PY{p}{]}

\PY{n}{task2c\PYZus{}image\PYZus{}rods\PYZus{}per\PYZus{}image} \PY{o}{=} \PY{l+m+mi}{3}
\end{Verbatim}
\end{tcolorbox}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{23}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{index} \PY{o}{=} \PY{l+m+mi}{0}
\end{Verbatim}
\end{tcolorbox}

    The most intuitive ideas suggest to apply some methods to get rid of the
iron powder from the image, or to detect and ignore all of them during
the other operations. The final approach combine both ideas as the first
option is not able to remove all of them without altering irreversibly
the image. It's worth to say that in general from change 1 objects
without holes are already ignored.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{24}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{def} \PY{n+nf}{preprocessing}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{n}{allow\PYZus{}print}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}\PY{p}{:}
    \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{} operations: Otsu \PYZhy{}\PYZgt{} closing \PYZhy{}\PYZgt{} opening \PYZhy{}\PYZgt{} dilation}
\PY{l+s+sd}{    Inputs:}
\PY{l+s+sd}{        image \PYZhy{} the image to preprocess as numpy matrix}
\PY{l+s+sd}{        allow\PYZus{}print \PYZhy{} True print preprocessing results}
\PY{l+s+sd}{    Outputs:}
\PY{l+s+sd}{        the preprocessed image}
\PY{l+s+sd}{    \PYZsq{}\PYZsq{}\PYZsq{}}
    \PY{k}{if} \PY{n}{image} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{image}\PY{o}{.}\PY{n}{size} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{or} \PY{n}{allow\PYZus{}print} \PY{o+ow}{is} \PY{k+kc}{None}\PY{p}{:}
        \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Some required arguments are not correct}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}

    \PY{k}{if} \PY{n}{allow\PYZus{}print}\PY{p}{:}
        \PY{n}{f} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{10}\PY{p}{,}\PY{l+m+mi}{10}\PY{p}{)}\PY{p}{)}
        \PY{n}{ax} \PY{o}{=} \PY{n}{f}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{221}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Original}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n}{ax}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{image}\PY{p}{)}

    \PY{c+c1}{\PYZsh{} segmentation}
    \PY{n}{task2c\PYZus{}ret\PYZus{}otsu}\PY{p}{,} \PY{n}{task2c\PYZus{}th\PYZus{}otsu} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{threshold}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{255}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{THRESH\PYZus{}BINARY\PYZus{}INV} \PY{o}{+} \PY{n}{cv2}\PY{o}{.}\PY{n}{THRESH\PYZus{}OTSU}\PY{p}{)}

    \PY{c+c1}{\PYZsh{} close it}
    \PY{n}{task2c\PYZus{}kernel} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{getStructuringElement}\PY{p}{(}\PY{n}{cv2}\PY{o}{.}\PY{n}{MORPH\PYZus{}CROSS}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}

    \PY{n}{closed} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{morphologyEx}\PY{p}{(}\PY{n}{task2c\PYZus{}th\PYZus{}otsu}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{MORPH\PYZus{}CLOSE}\PY{p}{,} \PY{n}{task2c\PYZus{}kernel}\PY{p}{)}
    \PY{k}{if} \PY{n}{allow\PYZus{}print}\PY{p}{:}
        \PY{n}{ax} \PY{o}{=} \PY{n}{f}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{222}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Closing}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n}{ax}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{closed}\PY{p}{)}

    \PY{c+c1}{\PYZsh{} then open it}
    \PY{n}{opened} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{morphologyEx}\PY{p}{(}\PY{n}{closed}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{MORPH\PYZus{}OPEN}\PY{p}{,} \PY{n}{task2c\PYZus{}kernel}\PY{p}{)}
    \PY{k}{if} \PY{n}{allow\PYZus{}print}\PY{p}{:}
        \PY{n}{ax} \PY{o}{=} \PY{n}{f}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{223}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Opening}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n}{ax}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{opened}\PY{p}{)}

    \PY{c+c1}{\PYZsh{} and finally dilate it}
    \PY{n}{task2c\PYZus{}dilation\PYZus{}kernel} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{getStructuringElement}\PY{p}{(}\PY{n}{cv2}\PY{o}{.}\PY{n}{MORPH\PYZus{}RECT}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{2}\PY{p}{,}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}
    \PY{n}{dilated} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{dilate}\PY{p}{(}\PY{n}{opened}\PY{p}{,} \PY{n}{task2c\PYZus{}dilation\PYZus{}kernel}\PY{p}{,} \PY{n}{iterations} \PY{o}{=} \PY{l+m+mi}{1}\PY{p}{)}
    \PY{k}{if} \PY{n}{allow\PYZus{}print}\PY{p}{:}
        \PY{n}{ax} \PY{o}{=} \PY{n}{f}\PY{o}{.}\PY{n}{add\PYZus{}subplot}\PY{p}{(}\PY{l+m+mi}{224}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Dilation}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n}{ax}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{dilated}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
    
    \PY{k}{return} \PY{n}{dilated}
\end{Verbatim}
\end{tcolorbox}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{25}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{task2c\PYZus{}image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{../data/}\PY{l+s+s2}{\PYZdq{}} \PY{o}{+} \PY{n}{task2c\PYZus{}image\PYZus{}filenames}\PY{p}{[}\PY{n}{index}\PY{p}{]}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{IMREAD\PYZus{}GRAYSCALE}\PY{p}{)}
    
\PY{n}{preprocessed\PYZus{}image} \PY{o}{=} \PY{n}{preprocessing}\PY{p}{(}\PY{n}{task2c\PYZus{}image}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_41_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Opening and closing has the general good effect of removing small
particles, but a too aggressive approach (large kernel) has the drawback
of corrupting the rods' circles, which are essential to classify the
rod's type. A possible solution is to open the image with a small kernel
to remove small particles, dilate the whole image a bit to close
possible broken circles and set a threshold value to ignore the small
remaining areas during the following phases.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{26}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{mean\PYZus{}num} \PY{o}{=} \PY{l+m+mi}{0}
\PY{n}{mean\PYZus{}den} \PY{o}{=} \PY{l+m+mi}{0}
\PY{c+c1}{\PYZsh{} default value}
\PY{n}{area\PYZus{}threshold} \PY{o}{=} \PY{l+m+mi}{15}

\PY{k}{for} \PY{n}{filename} \PY{o+ow}{in} \PY{n}{task2c\PYZus{}image\PYZus{}filenames}\PY{p}{:}
    \PY{n}{image} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{../data/}\PY{l+s+s2}{\PYZdq{}} \PY{o}{+} \PY{n}{filename}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{IMREAD\PYZus{}GRAYSCALE}\PY{p}{)}

    \PY{n}{preprocessed} \PY{o}{=} \PY{n}{preprocessing}\PY{p}{(}\PY{n}{image}\PY{p}{,} \PY{k+kc}{False}\PY{p}{)}
    \PY{n}{\PYZus{}}\PY{p}{,} \PY{n}{\PYZus{}}\PY{p}{,} \PY{n}{blob\PYZus{}info}\PY{p}{,} \PY{n}{\PYZus{}} \PY{o}{=} \PY{n}{cv2}\PY{o}{.}\PY{n}{connectedComponentsWithStats}\PY{p}{(}\PY{n}{preprocessed}\PY{p}{,} \PY{l+m+mi}{4}\PY{p}{,} \PY{n}{cv2}\PY{o}{.}\PY{n}{CV\PYZus{}32S}\PY{p}{)}
    
    \PY{k}{for} \PY{n}{blob} \PY{o+ow}{in} \PY{n}{np}\PY{o}{.}\PY{n}{sort}\PY{p}{(}\PY{n}{blob\PYZus{}info}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{4}\PY{p}{]}\PY{p}{)}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{5}\PY{p}{:}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{:}
        \PY{n}{mean\PYZus{}num} \PY{o}{+}\PY{o}{=} \PY{n}{blob}
        \PY{n}{mean\PYZus{}den} \PY{o}{+}\PY{o}{=} \PY{l+m+mi}{1}
    
\PY{k}{if} \PY{n}{mean\PYZus{}den} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{:}  
    \PY{n}{area\PYZus{}threshold} \PY{o}{=} \PY{n}{mean\PYZus{}num} \PY{o}{/} \PY{n}{mean\PYZus{}den}
    \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Threshold obtained with the mean: }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s2}{\PYZdq{}}\PY{o}{.}\PY{n}{format}\PY{p}{(}\PY{n}{area\PYZus{}threshold}\PY{p}{)}\PY{p}{)}
\PY{k}{else}\PY{p}{:}
    \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{No samples avaiable}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
Threshold obtained with the mean: 10.05
    \end{Verbatim}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{27}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} exclude blobs with area lower than a specific threshold}
\PY{k}{def} \PY{n+nf}{task2c\PYZus{}rod\PYZus{}filter}\PY{p}{(}\PY{n}{rod\PYZus{}info}\PY{p}{)}\PY{p}{:}
    \PY{l+s+sd}{\PYZsq{}\PYZsq{}\PYZsq{}}
\PY{l+s+sd}{    Inputs:}
\PY{l+s+sd}{        rod\PYZus{}info \PYZhy{} a numpy array containing information on the blob retrievable from the opencv connectedComponentsWithStats function}
\PY{l+s+sd}{    Outputs:}
\PY{l+s+sd}{        True if the rod must be filtered and not considered}
\PY{l+s+sd}{    \PYZsq{}\PYZsq{}\PYZsq{}}
    \PY{k}{if} \PY{n}{rod\PYZus{}info} \PY{o+ow}{is} \PY{k+kc}{None} \PY{o+ow}{or} \PY{n}{rod\PYZus{}info}\PY{o}{.}\PY{n}{size} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
        \PY{k}{raise} \PY{n+ne}{ValueError}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Some required arguments are not correct}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}

    \PY{c+c1}{\PYZsh{} if the area is below the threshold the blob must be filtered}
    \PY{k}{if} \PY{n}{rod\PYZus{}info}\PY{p}{[}\PY{l+m+mi}{4}\PY{p}{]} \PY{o}{\PYZlt{}} \PY{n}{area\PYZus{}threshold}\PY{p}{:}
        \PY{k}{return} \PY{k+kc}{True}
    \PY{k}{return} \PY{k+kc}{False}
\end{Verbatim}
\end{tcolorbox}


    % Add a bibliography block to the postdoc
    
    
    
\end{document}
